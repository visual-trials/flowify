<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Simple template</title>
  </head>
  <body>
      <canvas id="canvas" width="640" height="480" ></canvas>    
  </body>
  <script>
    var canvas = document.getElementById("canvas")
    var ctx = canvas.getContext("2d")

    var env = {
        _jsDrawRect: function (x, y, w, h) {
            ctx.strokeStyle = "black"
            ctx.rect(x, y, w, h)
            ctx.stroke()
        },
        _jsClearRect: function (x, y, w, h) {
            ctx.clearRect(x, y, w, h)
            ctx.beginPath()   // see: http://codetheory.in/why-clearrect-might-not-be-clearing-canvas-pixels/        
            ctx.closePath()
        },

        memoryBase: 0,
        tableBase: 0,
        memory: new WebAssembly.Memory({
            initial: 256,
            // maximum: 512,
        }),
        table: new WebAssembly.Table({
            initial: 4,
            // maximum: 4,
            element: 'anyfunc',
        }),
        abort: Math.log, // FIXME
    }

    var wasmFile = 'wasm/flowify.wasm'
    var request = new XMLHttpRequest()
    request.open('GET', wasmFile)
    request.responseType = 'arraybuffer'
    request.send()

    var latestChangeToWasm = null
    request.onload = function() {
    
        var wasmCode = request.response
        var responseHeaders = request.getAllResponseHeaders().split("\n")
        
        latestChangeToWasm = responseHeaders[1] // FIXME: ugly way of getting the latest changed time
        
        var wasmModule = new WebAssembly.Module(wasmCode)
        var wasmInstance = new WebAssembly.Instance(wasmModule, {
          env: env
        })

        // Frame loop
        var requestAnimFrame = function () {
            return  window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame   ||
                window.mozRequestAnimationFrame      ||
                window.oRequestAnimationFrame        ||
                window.msRequestAnimationFrame       ||
                function(callback, element){
                    window.setTimeout(function(){

                        callback(+new Date)
                    }, 1000 / 60)
                }
        }()
        
        // Taken from here: https://stackoverflow.com/questions/9677985/uncaught-typeerror-illegal-invocation-in-chrome
        requestAnimFrame = requestAnimFrame ? requestAnimFrame.bind(window) : null
        
        var iteration = 0
        var frameLoop = function() {
            wasmInstance.exports._draw_frame(iteration)
            
            /*
            env._jsClearRect(0, 0, 640, 480)
            env._jsDrawRect(iteration % 256 + 10, 10, 100, 100)
            */
            
            iteration++
            requestAnimFrame(frameLoop)
        }
        
        frameLoop()
    }
    
    /*
    var reloadWhenWasmChanged = function() {
    
        var request = new XMLHttpRequest()
        request.open('HEAD', wasmFile)
        request.setRequestHeader('cache-control', 'no-cache, must-revalidate, post-check=0, pre-check=0');
        request.send()

        request.onload = function() {
            var responseHeaders = request.getAllResponseHeaders().split("\n")
            
            var newChangeToWasm = responseHeaders[1] // FIXME: ugly way of getting the latest changed time
            // console.log('checking wasm: ' + newChangeToWasm + " -- " + latestChangeToWasm)
            if (latestChangeToWasm != null && newChangeToWasm !== latestChangeToWasm) {
                location.reload()
            }
            else {
                setTimeout(reloadWhenWasmChanged, 500)
            }
        }
    
    }
    
    setTimeout(reloadWhenWasmChanged, 500)
    */

  </script>
</html>
