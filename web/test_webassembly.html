<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Simple template</title>
  </head>
  <body>
      <canvas id="canvas" width="640" height="480" ></canvas>    
  </body>
  <script>
    var canvas = document.getElementById("canvas")
    var ctx = canvas.getContext("2d")

    // var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,139,128,128,128,0,2,96,4,127,127,127,127,0,96,0,0,2,146,128,128,128,0,1,3,101,110,118,10,106,115,68,114,97,119,82,101,99,116,0,0,3,131,128,128,128,0,2,0,1,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,168,128,128,128,0,3,6,109,101,109,111,114,121,2,0,14,100,114,97,119,95,114,101,99,116,97,110,103,108,101,0,1,10,100,114,97,119,95,102,114,97,109,101,0,2,10,165,128,128,128,0,2,140,128,128,128,0,0,32,0,32,1,32,2,32,3,16,0,11,142,128,128,128,0,0,65,10,65,10,65,228,0,65,228,0,16,0,11]) 

    var env = {
        _jsDrawRect: function (x, y, w, h) {
            ctx.strokeStyle = "black"
            ctx.rect(x, y, w, h)
            ctx.stroke()
        },
        memoryBase: 0,
        tableBase: 0,
        memory: new WebAssembly.Memory({
            initial: 256,
            // maximum: 512,
        }),
        table: new WebAssembly.Table({
            initial: 4,
            // maximum: 4,
            element: 'anyfunc',
        }),
        abort: Math.log, // FIXME
    }

    var wasmFile = 'wasm/flowify.wasm'
    var request = new XMLHttpRequest()
    request.open('GET', wasmFile)
    request.responseType = 'arraybuffer'
    request.send()

    var latestChangeToWasm = null
    request.onload = function() {
        var wasmCode = request.response
        var responseHeaders = request.getAllResponseHeaders().split("\n")
        
        latestChangeToWasm = responseHeaders[1] // FIXME: ugly way of getting the latest changed time
        
        var wasmModule = new WebAssembly.Module(wasmCode)
        var wasmInstance = new WebAssembly.Instance(wasmModule, {
          env: env
        })

        wasmInstance.exports._draw_frame()
    }
    
    var reloadWhenWasmChanged = function() {
    
        var request = new XMLHttpRequest()
        request.open('HEAD', wasmFile)
        request.setRequestHeader('cache-control', 'no-cache, must-revalidate, post-check=0, pre-check=0');
        request.send()

        request.onload = function() {
            var responseHeaders = request.getAllResponseHeaders().split("\n")
            
            var newChangeToWasm = responseHeaders[1] // FIXME: ugly way of getting the latest changed time
            // console.log('checking wasm: ' + newChangeToWasm + " -- " + latestChangeToWasm)
            if (latestChangeToWasm != null && newChangeToWasm !== latestChangeToWasm) {
                location.reload()
            }
            else {
                setTimeout(reloadWhenWasmChanged, 500)
            }
        }
    
    }
    
    setTimeout(reloadWhenWasmChanged, 500)

  </script>
</html>
